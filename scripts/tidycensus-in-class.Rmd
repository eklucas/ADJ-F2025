---
title: "tidycensus"
output:
  html_document:
    df_print: paged
---

### Preparation

Make sure you have an [activated API key from the census](https://api.census.gov/data/key_signup.html). Install the `usethis` package (`install.packages("usethis")`) and then run `usethis::edit_r_environ()` in the console below. This will open up a system file called `.REnviron`. In it, type this line: CENSUS_API_KEY= Then paste your API key, that long string of letters and numbers in your email from the Census Bureau. You do not need to use quotes. For example: CENSUS_API_KEY=a2392kf12oifo12n3kj (That's not a real key). Save and close the .REnviron file Restart R by going to Session -- Restart R.

```{r, message=F}
library(tidyverse)
library(tidycensus)
```

### Documentation

Here's the [documentation for tidycensus](https://walker-data.com/tidycensus/articles/basic-usage.html#geography-in-tidycensus-1)

Kyle Walker's documentation is good, it's worth consulting frequently. In particular check out:

-   [Basic usage](https://walker-data.com/tidycensus/articles/basic-usage.html)

-   [Margins of error](https://walker-data.com/tidycensus/articles/margins-of-error.html)

### Basic usage for decennial census

In the basic usage section Kyle has some example code near the top to pull median age by state from the 2020 decennial census, using the function `get_decennial()`:


```{r}
age20 <- get_decennial(geography = "state", 
                       variables = "P13_001N", 
                       year = 2020,
                       sumfile = "dhc")
```

Note the arguments for the `get_decennial()` function:

-   geography: what geography do you want the results aggregated by? This would give us numbers by state; we could also ask for numbers for the US as a whole by writing `geography = "us"`. Or get the numbers by county: `geography = "county"`.
-   variables: what topics / values are we interested in? "P13_001N" is actually median age. (Below you'll learn how to find variables)
-   year: the decennial census is conducted every 10 years, so 2020 is the most recent census.
-   sumfile: this is particular to the decennial census, it's referencing the "Demographic and Housing Characteristics summary file".

### Basic usage for the American Community Survey

If you scroll down near the bottom of the page to the header that says "Working with the ACS", Kyle also has some example code for the get_acs() function:
```{r}
###LIZ: note that here Kyle changes the name of the variable in the table to "medincome" so we know what "B19013_001" actually is: median household income

vt <- get_acs(geography = "county", 
              variables = c(medincome = "B19013_001"), 
              state = "VT", 
              year = 2021)

###LIZ: what we actually want to look at is Missouri, though, not Vermont, and let's use the most recent year: 

mo <- get_acs(geography = "state",
              variables = c(medincome = "B19013_001"), 
              state = "MO", 
              year = 2023)
```
### Finding variables for "detailed" tables (IDs that start with `B`)

To get data, you need to name the variables that you want from the Census data. In order to know what those variables are, it's helpful to reference a table of all variables for the Census's "Detailed Tables" (these are tables with IDs that usually start with B):
```{r}
v23 <- load_variables(2023, "acs5", cache = TRUE)
```

In this table `V23` the `name` column is the variable name and `label` describes the variable. `concept` is the table name and `geography` is the smallest available geography. See more about [geographies in the Basic Usage section](https://walker-data.com/tidycensus/articles/basic-usage.html#geography-in-tidycensus) of the documentation.

On data.census.gov we looked at the table "B25049" that gives information about households with complete and incomplete plumbing facilities. We can use the `grepl()` function to find all variables with that table id:

```{r}
v23 %>% filter(grepl("B25049", name))

# Consider that you could also search for keywords in the `label` column, such as the word plumbing
```

That got us the estimates; keep an eye on the margins of error (moe). If the moe is less than 1% of the estimate (`moe/estimate <= .01`), no problem. If it's between 1% and 10%, be cautious. If it's greater than 10%, the estimate is probably unreliable.

Now make the request with all the variables, renaming them as we go so they make sense in the final table: 
```{r}
plumbing <- get_acs(geography = "place",
        variables = c(total = "B25049_001",
                    owner = "B25049_002",
                    owner_complete = "B25049_003",
                    owner_lacking = "B25049_004",
                    renter = "B25049_005",
                    renter_complete = "B25049_006",
                    renter_lacking = "B25049_007"),
        state = "MO",
        year = 2023)

### if you don't want to type all the variables and don't care to rename them, use the `table` argument instead:

plumbing2 <- get_acs(geography = "place",
        table = "B25049",
        state = "MO",
        year = 2023)

### always calculate the moe_pct so you know what estimates are unreliable
plumbing %>% 
  mutate(moe_pct = moe/estimate) %>% 
  filter(moe_pct >= .1)

# in this table, most of them.


### you can pivot the table so each place has it's own row and the variables spread out as columns:
plumbing %>% 
  pivot_wider(names_from = variable, values_from = c(estimate, moe))
```

Here are the tables we explored:
```{r}
computers <- get_acs(geography = "place",
        table = "B28001",
        state = "MO",
        year = 2023)

comp <- get_acs(geography = "place",
        table = "B11001",
        state = "MO",
        year = 2023)

```

What if you wanted all the tables associated with "B11001", which includes racial breakdowns in "B11001A", "B11001B", etc? 
You can't specify more than one table in the `table` argument, and there are 90 variables associated with the B11001 tables. 
Here's a trick to find the relevant variables in the variables table, create a vector from them, and then use that in your request:

```{r}
# use filter to find all variables associated with "B11001"
comp_vars <- v23 %>% 
  filter(grepl("B11001",name)) %>% 
# the pull() function will take a column and turn it into a vector, which we are then saving into `comp_vars`.
  pull(name)

# since the `variables` argument of `get_acs()` can take a vector, we can feed it `comp_vars`:
comp <- get_acs(geography = "place",
        variables = comp_vars,
        state = "MO",
        year = 2023)

# and then our resulting table has all 90 variables for all places in Missouri. 
```

### Finding variables for "subject" tables (IDs that start with `S`)

```{r}
# add the suffix "/subject" to the second argument of the load_variables() function:
S23 <- load_variables(2023, "acs5/subject", cache = TRUE)
```

Now that you've got all the subject table variables, use `filter()` and `grepl()` again to find all the variables in that table:

```{r}
SNAP <- S23 %>% filter(grepl("S2201", name))
```










